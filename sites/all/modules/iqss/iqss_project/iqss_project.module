<?php

include_once('iqss_project.features.inc');

function iqss_project_theme(){

  $path = drupal_get_path('module', 'iqss_project') . '/theme';

  //top bocks

  $items['project_top_links'] = array(
    'arguments' => array('tree' => array()),
    'template' => 'project-top-links',
    'path' => $path,
  );

  $items['project_slideshow'] = array(
    'arguments' => array('tree' => array()),
    'template' => 'project-slideshow',
    'path' => $path,
  );

    $items['project_big_text'] = array(
    'arguments' => array(),
    'template' => 'project-big-text',
    'path' => $path,
  );

  //middle blocks
  $items['project_create'] = array(
  'arguments' => array('tree' => array()),
  'template' => 'project-create',
  'path' => $path,
  );

  $items['project_maintain'] = array(
  'arguments' => array('tree' => array()),
  'template' => 'project-maintain',
  'path' => $path,
  );

  $items['project_control'] = array(
    'arguments' => array('tree' => array()),
    'template' => 'project-control',
    'path' => $path,
  );

  $items['project_collaborate'] = array(
    'arguments' => array('tree' => array()),
    'template' => 'project-collaborate',
    'path' => $path,
  );

  //bottom block
    $items['project_site_examples'] = array(
    'arguments' => array('tree' => array()),
    'template' => 'project-site-examples',
    'path' => $path,
  );

  return $items;
}


function iqss_project_menu(){
  $items = array();

  // nodeautocomplete callback for scholar
  $items['iqss_scholar_home'] = array(
    'type' => MENU_CALLBACK,
    'title' => 'Scholars\' Web Sites Project',
    'page callback' => 'iqss_project_homepage',
    'access arguments' => array(
      'access content'
    ),
  );

  return $items;
}

function iqss_project_homepage(){
  $s_content = '<div id="content-row-1">'.theme('project_big_text').'</div>';
  $s_content .= '<div id="content-row-2">'.theme('project_create') . theme('project_maintain') . theme('project_control') . theme('project_collaborate'). '</div>' ;
  return $s_content;
}

/**
 * Implementation of hook_preprocess_page()
 */
function scholar_projects_front_preprocess_page(&$vars){
  $vars['front_top_links'] = theme('project_top_links');
}

/**
 * Implementation of template_preprocess_hook()
 */
function template_preprocess_project_top_links(&$vars){
  if (!module_exists('scholarregister')) return;
  global $user;

  //we always allow admin and users with "vsite create access" to see site registration button.
  //and we allow anonymous users to create a new user account and new site
  if ( node_access('create', variable_get('scholar_content_type', 'vsite' )) || in_array('anonymous user', $user -> roles)) {
    $allow = TRUE;
  }

  // all authenticated users
  else{
    // site-owners
    if ($vsites = vsite_get_vsite_by_owner($user->uid)){
      $allow = scholarregister_vsite_exists_access($vsites);
      $site_link = (count($vsites) > 1) ? 'user' : $vsites[0] -> purl;
    }
    //  non-site owners
    else{
      $allow = TRUE;
    }
  }
  //link for front page button
  $vars['front_button_link'] = ($allow) ? l('Get your web site!', 'site/register') : l('Go to your site', $site_link);
}

